<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mini LLM Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font: 16px/1.4 system-ui, sans-serif; max-width: 720px; margin: 2rem auto; padding: 0 1rem; }
    #log { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; border-radius: 8px; min-height: 200px; }
    .msg { margin: .5rem 0; }
    .you { color: #333; }
    .bot { color: #0a6; }
    form { display: flex; gap: .5rem; margin-top: .5rem; }
    input { flex: 1; padding: .6rem; }
    button { padding: .6rem 1rem; }
  </style>
</head>
<body>
  <h1>Mini LLM Chat</h1>
  <div id="log"></div>
  <form id="chat">
    <input id="q" placeholder="Ask somethingâ€¦" autofocus />
    <button>Send</button>
  </form>

  <script>
    const log = document.getElementById('log');
    const form = document.getElementById('chat');
    const q = document.getElementById('q');
    const history = [];

    function addLine(text, cls='bot') {
      const div = document.createElement('div');
      div.className = 'msg ' + cls;
      div.textContent = text;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = q.value.trim();
      if (!user) return;
      q.value = '';
      addLine('You: ' + user, 'you');

      const messages = [
        { role: 'system', content: 'You are a helpful assistant.' },
        ...history,
        { role: 'user', content: user }
      ];

      const resp = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ messages, stream: true })
      });

      // stream via SSE
      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let acc = 'Assistant: ';

      const cur = document.createElement('div');
      cur.className = 'msg bot';
      cur.textContent = acc;
      log.appendChild(cur);

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value);
        // parse SSE "data: ..." lines
        for (const line of chunk.split('\n')) {
          if (!line.startsWith('data:') && !line.startsWith('event:')) continue;
          if (line.startsWith('event: done')) continue;
          if (line.startsWith('data:')) {
            const token = line.slice(5).trim();
            acc += token;
            cur.textContent = acc;
            log.scrollTop = log.scrollHeight;
          }
        }
      }

      const answer = acc.replace(/^Assistant:\s*/, '');
      history.push({ role: 'user', content: user }, { role: 'assistant', content: answer });
    });
  </script>
</body>
</html>
